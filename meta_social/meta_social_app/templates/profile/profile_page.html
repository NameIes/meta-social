{% extends 'profile/base.html' %}
{% load static %}

{% block content %}
<script src="https://kit.fontawesome.com/8c5f8983b2.js" crossorigin="anonymous"></script>
  <div class="row text-left">
    <div class="col-lg-3 col-md pd-left-none no-pd mb-3">
      <div class="card">
        <style>
          .rollover {
            transition: 0.3s;
          }

          .rollover:hover {
            transition: 0.7s;
            opacity: 0.7;
          }

          .kollaz{
            display: flex;
             flex-wrap: wrap;
          }
        </style>
        {% if user == c_user %}
          <a href="/accounts/profile/change_avatar/">
            <img src="{{ c_user.profile.image.url }}" class="card-img-top rollover"></img>
          </a>
        {% else %}
          <img src="{{ c_user.profile.image.url }}" class="card-img-top"></img>
        {% endif %}
        <div class="card-body">
          {% if c_user == user %}
            <hr class="mt-0">
            <a href="/accounts/profile/{{ c_user.id }}/edit_profile/" class="btn btn-block btn-primary">Редактировать</a>
          {% else %}
              <hr class="mt-0">
              {% if not is_in_blacklist and not is_friend %}
                <form method="POST" action="/friends/send_request/{{ c_user.id }}/">
                  {% csrf_token %}
                  <input class="btn btn-block btn-primary" type="submit" value="Добавить в друзья">
                </form>
              {% else %}
                {% if is_in_blacklist %}
                  <p class="btn btn-block btn-primary">Вы в черном списке</p>
                {% else %}
                  <p class="btn btn-block btn-primary">В друзьях</p>
                  {% endif %}
          {% endif %}
        {% endif %}
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title">Друзья</h6>

          {% if c_user.profile.friends.all %}
                <ul class="list-group list-group-flush">
                    {% for friend in c_user.profile.friends.all %}
                  <div style="display: flex; flex-wrap: wrap;">
                        <li class="list-group-item" style="padding-left: 2.5px; padding-right: 2.5px;">
                            <img src="{{ friend.profile.image.url }}" class="rounded-circle border border-dark " style="margin-left: 20px" width=35 height=35>
                          <br>

                            <a href="/accounts/profile/{{ friend.id }}/" class=" ml-2" >{{ friend.username }}</a>
                        </li>
                    {% endfor %}
                    </div>
                </ul>
            {% else %}
                Список друзей пуст.
            {% endif %}
        </div>
      </div>
      <div class="card mt-3 mb-3">
        <div class="card-body">
          <h6 class="card-title">Сообщества</h6>
        </div>
      </div>
    </div>
    <div class="col-lg-9 col-md no-pd mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title float-left">{% if c_user.first_name or c_user.last_name %}{{ c_user.first_name }} {{ c_user.last_name }}{% else %}{{ c_user.username }}{% endif %}</h5>
          <small class="float-right text-muted">{% if is_online %}Онлайн{% else %}Оффлайн{% endif %}</small>
          <br><hr>
          <p class="card-text">
            {% if c_user.profile.job and not c_user.profile.study or c_user.profile.job and c_user.profile.study %}
                Работа: {{ c_user.profile.job }}
            {% else %}
                {% if c_user.profile.study and not c_user.profile.job %}
                Учеба: {{ c_user.profile.study }}
                {% else %}
                    {% if not c_user.profile.study and not c_user.profile.job %}
                        Место работы/учебы: -
                    {% endif %}
                {% endif %}
            {% endif %}
          </p>
           <p class="card-text">
            {% if c_user.profile.job and c_user.profile.study %}
                Учеба: {{ c_user.profile.study }}
            {% endif %}
          </p>
          <p class="card-text">
            {% if c_user.profile.biography %}
                Биография: {{ c_user.profile.biography }}
            {% else %}
                Биография: -
            {% endif %}
          </p>
          <p class="card-text">
            {% if c_user.profile.country %}
                Страна: {{ c_user.profile.country.name }}
            {% else %}
                Страна: -
            {% endif %}
          </p>
          <p class="card-text">
            {% if c_user.profile.birth %}
                Дата рождения: {{ c_user.profile.birth }}
            {% endif %}
          </p>
          {% if c_user.profile.show_email %}
            <p class="card-text">
              {% if c_user.email %}
                Почта: {{ c_user.email }}
              {% endif %}
            </p>
          {% endif %}
        </div>
      </div>

      {% if c_user == user %}
        <div class="mt-3">
            {% include 'post_menu.html' %}
        </div>
      {% endif %}
      {% if is_in_blacklist %}
            <h5 class="mt-3 text-center">Не доступно для просмотра</h5>
      {% else %}
          {% if c_user.profile.posts and not is_in_blacklist %}
            {% for post in c_user.profile.posts %}
              <div class="card mt-3">
                <div class="card-body">
                  <img src="{{ post.get_owner.image.url }}" class="rounded-circle border border-dark" width=35 height=35>
                  <a href="{{ post.get_link }}">{{ post.get_owner_name }}</a>
                    {% if c_user == user %}
                        <button style="background: white; box-shadow: 0px 0px 0px transparent; border: 0px solid transparent; text-shadow: 0px 0px 0px transparent;"  data-toggle="modal" data-target="#removingPostModal" class="float-right"><i class="fas fa-ban"></i></button>
                        <button style="background: white; box-shadow: 0px 0px 0px transparent; border: 0px solid transparent; text-shadow: 0px 0px 0px transparent;"  data-toggle="modal" data-target="#editPostModal" class="float-right"><i class="far fa-edit"></i></button>
                    {% endif %}
                  <p class="card-text mt-2" id="id-post-text">{{ post.text }}</p>
                  <div class="kollaz">
                  {% if post.get_images %}
                    {% for post_img in post.get_images %}
                    {% if post.get_images.count > 1 %}
                      <img src="{{ post_img.image.url }}" width="50%" class="mb-1">
                    {%else%}
                       <img src="{{ post_img.image.url }}" width="100%" class="mb-1">
                    {% endif %}
                    {% endfor %}
                  {% endif %}
                  </div>

                  <hr class="mt-1 mb-1">
                   <i class="far fa-heart" style="margin-right: 10px"></i>
                  <a href="/post/{{ post.id }}" class="text-muted mb-0"><i class="far fa-comment"></i></a>
                    {% if c_user == user %}
                        <div class="modal fade" id="editPostModal" tabindex="-1" role="dialog" aria-labelledby="editPostModalLabel" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="editPostModalLabel">Modal title</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <textarea class="form-control" style="min-width: 100%" id="updated-post-text">{{ post.text }}</textarea>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="edit_post(event, '/post/{{ post.id }}/edit/')">Сохранить</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="modal fade" id="removingPostModal" tabindex="-1" role="dialog" aria-labelledby="removingPostModalLabel" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="removingPostModalLabel">Удалить пост?</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Нет</button>
                                <button type="button" class="btn btn-primary" onclick="remove_post(event, '/post/{{ post.id }}/remove/')" data-dismiss="modal">Да</button>
                              </div>
                            </div>
                          </div>
                        </div>
                    {% endif %}
                  <span class="text-muted mb-0 float-right">{{ post.date }}</span>

                </div>
                  <ul id="all_comments" style="padding-left: 0;">
        {% if post.comments %}
                {% for comment in post.comments|slice:":1" %}

                       <div class="card" style="font-size: 15px; width: 100%; height: 130px; ">
                       <div class="card-body" style="">

                        <img src="{{ comment.user.profile.image.url }}" class="rounded-circle border border-dark" width=35 height=35 style="margin-right: 600px">
                           <p style="text-align: left; margin-inline-start: 2px; position: absolute; margin-left: 50px;  margin-top: -30px">  {{ comment.user.username }}</p>
                            <div class="media-body">
                                    <h5 style="text-align: left; margin-inline-start: 10px; padding: 5px; font-size: 15px;">{{ comment.text }}</h5>
                                </div>
                            <hr class="mt-1 mb-1">
                            <p style="text-align: right; margin: 3px">Создан {{ comment.date }}</p>

                        </div>
                           </div>


                {% endfor %}
        {% endif %}
    </ul>
              </div>
            {% endfor %}
          {% endif %}
          {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra__js %}
    <script>
        autosize(document.getElementById("updated-post-text"));

        function remove_post(e, link) {
            $.ajax({
                type: "POST",
                url: link,
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    e.target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.remove();
                }
            })

        }

        function edit_post(e, link) {
            let edited_text = document.getElementById("updated-post-text");
            let old_text = document.getElementById("id-post-text");
            $.ajax({
                type: "POST",
                url: link,
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    text: edited_text.value
                },
                success: function() {
                    old_text.innerText = edited_text.value;
                }
            })
        }

    </script>
{% endblock %}
