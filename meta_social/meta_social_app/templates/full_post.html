{% extends 'base_menu.html' %}

{% block center %}
    <div class="card mt-3">
        <div class="card-body text-left">
            <img src="{{ post.user.profile }}" class="rounded-circle border border-dark" width=35 height=35>
            <a href="/accounts/profile/{{ post.user.id }}/">{{ post.user.username }}</a>
            <p class="card-text mt-2">{{ post.text }}</p>

            {% if post.get_images %}
                {% for post_img in post.get_images %}
                    <img src="{{ post_img.image.url }}" width="100%" class="mb-1">
                {% endfor %}
            {% endif %}

            <hr class="mt-1 mb-1">
            <span class="text-muted mb-0 float-right">{{ post.date }}</span>
        </div>
    </div>
    <div class="form-group mt-2">
        <textarea class="form-control" rows="3" placeholder="Комментарий" name="comment" id="id_comment"></textarea>
        <button class="btn btn-primary mt-2" onclick="proc_comment(event, '/post/{{ post.id }}/ajax/', )">Оставить комментарий</button>
    </div>
    <div id="all_comments">
        {% if post.comments %}
            {% for comment in post.comments %}
                   <div class="card mb-2">
                       <div class="card-body">
                        <img src="{{ comment.user.profile }}" class="rounded-circle border border-dark" width=35 height=35 style="margin-right: 640px">
                           <p style="text-align: left; margin-inline-start: 2px; position: absolute; margin-left: 50px;  margin-top: -30px"><a href="/accounts/profile/{{ comment.user.id }}/">{{ comment.user.username }}</a></p>
                            <div class="media-body">
                                <h5 style="text-align: left; margin-inline-start: 10px; padding-top: 5px;">{{ comment.text }}</h5>
                            </div>
                            <hr class="mt-1 mb-1">
                            <p style="text-align: right; margin: 3px">Создан {{ comment.date }}</p>
                        </div>
                   </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block extra__js %}
    <script>
        function proc_comment(e, link){
            let textar = document.getElementById('id_comment');
            let comment_text = textar.value;
            $.ajax({
                type: "POST",
                url: link,
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    text: comment_text
                },
                success: function (result) {
                    textar.value = "";
                    let json = result;

                    const li = document.createElement("div");
                    let len =  $('ul#all_comments li').length;

                    let date_arr = json['date'].split(" ");
                    let date_year = date_arr[0].split("-");

                    let day = date_year[2][0] === '0' ? date_year[2][1] : date_year[2];
                    let month = "";

                    switch (date_year[1]) {
                        case "01":
                            month = "января"; break;
                        case "02":
                            month = "февраля"; break;
                        case "03":
                            month = "марта"; break;
                        case "04":
                            month = "апреля"; break;
                        case "05":
                            month = "мая"; break;
                        case "06":
                            month = "июня"; break;
                        case "07":
                            month = "июля"; break;
                        case "08":
                            month = "августа"; break;
                        case "09":
                            month = "сентября"; break;
                        case "10":
                            month = "октября"; break;
                        case "11":
                            month = "ноября"; break;
                        case "12":
                            month = "декабря"; break;
                        default:
                            console.log('Ooops');
                    }

                    let time = date_arr[1].split(":");
                    
                    let hours = "";

                    if (time[0][0] == '0') {
                        hours = time[0][1];
                    } else {
                        hours = time[0];
                    }

                    let str_date = `Создан ${day} ${month} ${date_year[0]} г. ${hours}:${time[1]}`;

                    li.innerHTML = `
                        <div class="card mb-2">
                           <div class="card-body">
                            <img src="{{ user.profile.image.url }}" class="rounded-circle border border-dark" width=35 height=35 style="margin-right: 640px">
                               <p style="text-align: left; margin-inline-start: 2px; position: absolute; margin-left: 50px;  margin-top: -30px"><a href="/accounts/profile/${json['id']}/">${json['username']}</a></p>
                                <div class="media-body">
                                        <h5 style="text-align: left; margin-inline-start: 10px; padding-top: 5px;">${json['text']}</h5>
                                    </div>
                                <hr class="mt-1 mb-1">
                                <p style="text-align: right; margin: 3px">${str_date}</p>

                            </div>
                       </div>
                    `;
                    document.getElementById('all_comments').appendChild(li);
                }
            })
        }
    </script>
{% endblock %}